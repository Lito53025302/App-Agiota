<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="theme-color" content="#007bff">
<link rel="stylesheet" href="styles.css">
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }
</script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema F√°cil</title>
<style>
    /* Estilos gerais */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background: #f5f7fa;
        color: #333;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    h1 {
        margin: 0;
        padding: 20px 10px;
        font-weight: 700;
        font-size: 1.8em;
        text-align: center;
        background: linear-gradient(90deg, #0066ff, #00ccff);
        color: white;
        -webkit-user-select: none;
        user-select: none;
    }
    /* Container principal */
    .container {
        max-width: 380px;
        margin: 20px auto;
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 16px rgb(0 0 0 / 0.15);
    }
    /* Bot√µes */
    button {
        padding: 12px 0;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        margin: 10px 0;
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-size: 1.1em;
    }
    button.primary {
        background: linear-gradient(90deg, #007bff, #00c0ff);
        color: white;
        box-shadow: 0 4px 10px rgb(0 123 255 / 0.6);
    }
    button.primary:hover {
        background: linear-gradient(90deg, #0056b3, #009ebf);
        box-shadow: 0 5px 14px rgb(0 86 179 / 0.8);
    }
    button.secondary {
        background: #ddd;
        color: #555;
        box-shadow: 0 3px 7px rgb(0 0 0 / 0.12);
    }
    button.secondary:hover {
        background: #ccc;
    }

    /* √Årea de busca */
    .search-area {
        margin: 15px 0;
        text-align: center;
    }
    .search-area input[type="text"],
    .search-area input[type="search"] {
        width: 75%;
        padding: 10px;
        font-size: 1em;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-right: 8px;
    }
    /* Lista de mensalidades vencendo */
    h2 {
        font-weight: 700;
        font-size: 1.25em;
        margin: 15px 0 10px;
        border-bottom: 2px solid #00c0ff;
        padding-bottom: 6px;
        color: #007bff;
    }
    ul#duePayments {
        list-style: none;
        padding-left: 0;
        max-height: 160px;
        overflow-y: auto;
    }
    ul#duePayments li {
        background: #e6f2ff;
        margin: 8px 0;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9em;
        box-shadow: inset 0 2px 4px rgb(0 123 255 / 0.15);
    }
    /* Formularios e telas */
    .hidden {
        display: none !important;
    }
    form {
        display: flex;
        flex-direction: column;
    }
    form input[type="text"],
    form input[type="tel"],
    form input[type="number"],
    form input[type="file"],
    form input[type="search"],
    form input[type="date"] {
        margin-bottom: 12px;
        padding: 10px;
        font-size: 1em;
        border-radius: 6px;
        border: 1px solid #ccc;
        transition: border-color 0.3s;
    }
    form input[type="text"]:focus,
    form input[type="tel"]:focus,
    form input[type="number"]:focus,
    form input[type="search"]:focus,
    form input[type="date"]:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 6px #00aaff;
    }
    /* Perfil do cliente */
    #clientProfile img {
        max-width: 120px;
        border-radius: 50%;
        display: block;
        margin: 0 auto 8px auto;
        box-shadow: 0 4px 10px rgb(0 123 255 / 0.3);
    }
    #clientData {
        font-size: 1em;
        line-height: 1.4em;
        margin-bottom: 20px;
    }
    /* Container de empr√©stimos no perfil */
    #loanSection input[type="number"] {
        width: calc(50% - 12px);
        margin-right: 8px;
        box-sizing: border-box;
    }
    #loanSection {
        display: flex;
        margin-bottom: 20px;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    #loanSection input[type="number"] {
        margin-bottom: 10px;
    }
    #loanSection button {
        width: auto;
        padding: 10px 15px;
        font-size: 1em;
        margin-left: auto;
        margin-top: 0;
        flex-shrink: 0;
        white-space: nowrap;
    }
    /* Bot√µes de a√ß√£o no perfil */
    #profileActions button {
        width: 31%;
        margin-right: 2%;
        font-size: .95em;
    }
    #profileActions button:last-child {
        margin-right: 0;
    }

    /* Mensagem de lembrete cobran√ßa */
    #reminderMessage {
        background: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 6px;
        margin-top: 10px;
        text-align: center;
        font-weight: 600;
    }

    /* Preview de foto no form cadastro */
    #photoPreview {
        display: block;
        max-width: 120px;
        border-radius: 50%;
        margin: 10px auto 20px auto;
        box-shadow: 0 4px 10px rgb(0 123 255 / 0.3);
        object-fit: cover;
        height: 120px;
        width: 120px;
    }

    /* Ajustes mobile */
    @media (max-width: 400px) {
        .container {
            margin: 10px;
            padding: 15px;
        }
        #loanSection {
            flex-direction: column;
        }
        #loanSection input[type="number"] {
            width: 100%;
            margin: 0 0 10px 0;
        }
        #loanSection button {
            width: 100%;
            margin-left: 0;
        }
        #profileActions button {
            width: 100%;
            margin: 6px 0;
        }
        .search-area input[type="text"],
        .search-area input[type="search"] {
            width: 100%;
            margin-bottom: 10px;
        }
    }

    /* Estilos do Modal */
    .modal {
        display: none; /* Escondido por padr√£o */
        position: fixed; /* Fixo na tela */
        z-index: 1; /* Fica em cima */
        left: 0;
        top: 0;
        width: 100%; /* Largura total */
        height: 100%; /* Altura total */
        overflow: auto; /* Habilita rolagem se necess√°rio */
        background-color: rgb(0,0,0); /* Cor de fundo */
        background-color: rgba(0,0,0,0.4); /* Fundo com opacidade */
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% do topo e centralizado */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Largura do modal */
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    /* Estilos do Dashboard */
    #dashboard {
        margin-bottom: 18px;
    }
    .dash-card {
        background: #f0f8ff;
        border-radius: 8px;
        padding: 15px;
        flex: 1;
        min-width: 180px;
        box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    }
    .dash-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 1.1em;
        color: #007bff;
    }
    .dash-value {
        font-size: 1.5em;
        font-weight: 700;
        color: #333;
    }

    /* DASHBOARD FINANCEIRO */
    .dashboard {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 18px;
        background: #f0f8ff;
        border-radius: 10px;
        padding: 12px 8px 8px 8px;
        box-shadow: 0 2px 8px rgb(0 123 255 / 0.10);
    }
    .dashboard-item {
        flex: 1 1 45%;
        min-width: 140px;
        margin: 0 0 8px 0;
        background: #fff;
        border-radius: 8px;
        padding: 10px 8px 8px 8px;
        box-shadow: 0 4px 16px 0 rgb(0 123 255 / 0.18), 0 1.5px 4px rgb(0 123 255 / 0.10);
        transition: box-shadow 0.2s;
        text-align: center;
    }
    .dashboard-item:hover {
        box-shadow: 0 8px 24px 0 rgb(0 123 255 / 0.22), 0 2px 8px rgb(0 123 255 / 0.13);
    }
    .dashboard-label {
        font-size: 0.98em;
        color: #007bff;
        font-weight: 600;
        margin-bottom: 2px;
    }
    .dashboard-value {
        font-size: 1.25em;
        font-weight: bold;
        color: #222;
        margin-top: 2px;
    }
    @media (max-width: 400px) {
        .dashboard {
            flex-direction: column;
            gap: 6px;
        }
        .dashboard-item {
            min-width: 100%;
        }
    }

    /* DASHBOARD FINANCEIRO COMPACTO */
    .compact-dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 14px;
        background: #f0f8ff;
        border-radius: 10px;
        padding: 6px 4px 4px 4px;
        box-shadow: 0 2px 8px rgb(0 123 255 / 0.10);
    }
    .compact-dashboard .dashboard-item {
        min-width: unset;
        margin: 0;
        background: #fff;
        border-radius: 8px;
        padding: 7px 4px 6px 4px;
        box-shadow: 0 1px 4px rgb(0 123 255 / 0.08);
        text-align: center;
    }
    .compact-dashboard .dashboard-label {
        font-size: 0.92em;
        color: #007bff;
        font-weight: 600;
        margin-bottom: 1px;
    }
    .compact-dashboard .dashboard-value {
        font-size: 1.08em;
        font-weight: bold;
        color: #222;
        margin-top: 1px;
    }
    @media (max-width: 500px) {
        .compact-dashboard {
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 2px;
        }
        .compact-dashboard .dashboard-item {
            padding: 5px 2px 4px 2px;
        }
        .compact-dashboard .dashboard-label {
            font-size: 0.85em;
        }
        .compact-dashboard .dashboard-value {
            font-size: 1em;
        }
    }
    @media (max-width: 350px) {
        .compact-dashboard {
            grid-template-columns: 1fr;
        }
    }

    /* Utilit√°rios para margens e largura */
    .btn-margin { margin-top: 10px; }
    .btn-margin-lg { margin-top: 20px; }
    .btn-fullwidth { width: 100%; }
    .section-margin { margin-top: 15px; }
    .modal-maxwidth { max-width: 600px; }
    .mb-10 { margin-bottom: 10px; }
    .report-content-scroll { max-height: 350px; overflow-y: auto; }

    /* Estilo para o card de empr√©stimo e bot√£o flutuante */
    .loan-card {
        position: relative;
        background: #f0f8ff;
        padding: 12px 16px 12px 12px;
        margin-bottom: 12px;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgb(0 123 255 / 0.10);
        display: flex;
        align-items: center;
        min-height: 80px;
    }
    .loan-info {
        flex: 1;
        font-size: 0.98em;
    }
    .pay-fab {
        position: relative;
        right: 0;
        margin-left: 12px;
        background: linear-gradient(135deg, #00c0ff 60%, #007bff 100%);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        box-shadow: 0 4px 12px rgb(0 123 255 / 0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        cursor: pointer;
        transition: box-shadow 0.2s, background 0.2s;
        z-index: 1;
        outline: none;
    }
    .pay-fab:hover {
        background: linear-gradient(135deg, #009ebf 60%, #0056b3 100%);
        box-shadow: 0 6px 18px rgb(0 123 255 / 0.28);
    }
    @media (max-width: 500px) {
        .loan-card {
            flex-direction: column;
            align-items: flex-start;
            padding: 10px 10px 10px 10px;
        }
        .pay-fab {
            margin: 10px 0 0 0;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
        }
    }

    /* Perfil do cliente - layout lado a lado */
    .profile-flex {
        display: flex;
        align-items: flex-start;
        gap: 28px;
        margin-bottom: 18px;
    }
    .profile-flex #clientPhoto {
        width: 140px;
        height: 140px;
        max-width: 160px;
        max-height: 160px;
        border-radius: 50%;
        object-fit: cover;
        box-shadow: 0 6px 18px rgb(0 123 255 / 0.22);
        margin: 0;
        flex-shrink: 0;
    }
    .profile-flex #clientData {
        font-size: 1.08em;
        line-height: 1.6em;
        margin-bottom: 0;
        margin-top: 6px;
    }
    @media (max-width: 600px) {
        .profile-flex {
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .profile-flex #clientPhoto {
            width: 110px;
            height: 110px;
            max-width: 120px;
            max-height: 120px;
        }
        .profile-flex #clientData {
            text-align: center;
        }
    }

    /* Estilos do Modal */
    .modal {
        display: none; /* Escondido por padr√£o */
        position: fixed; /* Fixo na tela */
        z-index: 1; /* Fica em cima */
        left: 0;
        top: 0;
        width: 100%; /* Largura total */
        height: 100%; /* Altura total */
        overflow: auto; /* Habilita rolagem se necess√°rio */
        background-color: rgb(0,0,0); /* Cor de fundo */
        background-color: rgba(0,0,0,0.4); /* Fundo com opacidade */
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% do topo e centralizado */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Largura do modal */
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    /* Estilos do Dashboard */
    #dashboard {
        margin-bottom: 18px;
    }
    .dash-card {
        background: #f0f8ff;
        border-radius: 8px;
        padding: 15px;
        flex: 1;
        min-width: 180px;
        box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    }
    .dash-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 1.1em;
        color: #007bff;
    }
    .dash-value {
        font-size: 1.5em;
        font-weight: 700;
        color: #333;
    }

    /* DASHBOARD FINANCEIRO */
    .dashboard {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 18px;
        background: #f0f8ff;
        border-radius: 10px;
        padding: 12px 8px 8px 8px;
        box-shadow: 0 2px 8px rgb(0 123 255 / 0.10);
    }
    .dashboard-item {
        flex: 1 1 45%;
        min-width: 140px;
        margin: 0 0 8px 0;
        background: #fff;
        border-radius: 8px;
        padding: 10px 8px 8px 8px;
        box-shadow: 0 4px 16px 0 rgb(0 123 255 / 0.18), 0 1.5px 4px rgb(0 123 255 / 0.10);
        transition: box-shadow 0.2s;
        text-align: center;
    }
    .dashboard-item:hover {
        box-shadow: 0 8px 24px 0 rgb(0 123 255 / 0.22), 0 2px 8px rgb(0 123 255 / 0.13);
    }
    .dashboard-label {
        font-size: 0.98em;
        color: #007bff;
        font-weight: 600;
        margin-bottom: 2px;
    }
    .dashboard-value {
        font-size: 1.25em;
        font-weight: bold;
        color: #222;
        margin-top: 2px;
    }
    @media (max-width: 400px) {
        .dashboard {
            flex-direction: column;
            gap: 6px;
        }
        .dashboard-item {
            min-width: 100%;
        }
    }

    /* DASHBOARD FINANCEIRO COMPACTO */
    .compact-dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 14px;
        background: #f0f8ff;
        border-radius: 10px;
        padding: 6px 4px 4px 4px;
        box-shadow: 0 2px 8px rgb(0 123 255 / 0.10);
    }
    .compact-dashboard .dashboard-item {
        min-width: unset;
        margin: 0;
        background: #fff;
        border-radius: 8px;
        padding: 7px 4px 6px 4px;
        box-shadow: 0 1px 4px rgb(0 123 255 / 0.08);
        text-align: center;
    }
    .compact-dashboard .dashboard-label {
        font-size: 0.92em;
        color: #007bff;
        font-weight: 600;
        margin-bottom: 1px;
    }
    .compact-dashboard .dashboard-value {
        font-size: 1.08em;
        font-weight: bold;
        color: #222;
        margin-top: 1px;
    }
    @media (max-width: 500px) {
        .compact-dashboard {
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 2px;
        }
        .compact-dashboard .dashboard-item {
            padding: 5px 2px 4px 2px;
        }
        .compact-dashboard .dashboard-label {
            font-size: 0.85em;
        }
        .compact-dashboard .dashboard-value {
            font-size: 1em;
        }
    }
    @media (max-width: 350px) {
        .compact-dashboard {
            grid-template-columns: 1fr;
        }
    }

    /* Utilit√°rios para margens e largura */
    .btn-margin { margin-top: 10px; }
    .btn-margin-lg { margin-top: 20px; }
    .btn-fullwidth { width: 100%; }
    .section-margin { margin-top: 15px; }
    .modal-maxwidth { max-width: 600px; }
    .mb-10 { margin-bottom: 10px; }
    .report-content-scroll { max-height: 350px; overflow-y: auto; }

    /* Estilo para o card de empr√©stimo e bot√£o flutuante */
    .loan-card {
        position: relative;
        background: #f0f8ff;
        padding: 12px 16px 12px 12px;
        margin-bottom: 12px;
        border-radius: 14px;
        box-shadow: 0 2px 8px rgb(0 123 255 / 0.10);
        display: flex;
        align-items: center;
        min-height: 80px;
    }
    .loan-info {
        flex: 1;
        font-size: 0.98em;
    }
    .pay-fab {
        position: relative;
        right: 0;
        margin-left: 12px;
        background: linear-gradient(135deg, #00c0ff 60%, #007bff 100%);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        box-shadow: 0 4px 12px rgb(0 123 255 / 0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        cursor: pointer;
        transition: box-shadow 0.2s, background 0.2s;
        z-index: 1;
        outline: none;
    }
    .pay-fab:hover {
        background: linear-gradient(135deg, #009ebf 60%, #0056b3 100%);
        box-shadow: 0 6px 18px rgb(0 123 255 / 0.28);
    }
    @media (max-width: 500px) {
        .loan-card {
            flex-direction: column;
            align-items: flex-start;
            padding: 10px 10px 10px 10px;
        }
        .pay-fab {
            margin: 10px 0 0 0;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
        }
    }
</style>
</head>
<body>

<!-- Tela de Login por Token -->
<div id="loginScreen" style="text-align:center;padding:40px;">
  <h2>Acesso ao Sistema</h2>
  <input type="password" id="tokenInput" placeholder="Digite seu token" style="padding:10px;width:60%;margin-bottom:12px;border-radius:6px;border:1px solid #ccc;">
  <br>
  <button onclick="checkToken()" style="padding:10px 20px;border:none;border-radius:6px;background:#007bff;color:white;font-weight:bold;">Entrar</button>
</div>


<!-- Cabe√ßalho com nome do sistema -->
<h1>Sistema F√°cil</h1>

<div class="container">

    <!-- Tela Principal -->
    <div id="homeScreen" style="display:none;">
        <!-- Dashboard Financeiro -->
        <div id="dashboard" class="dashboard compact-dashboard">
            <div class="dashboard-item">
                <div class="dashboard-label">Total Emprestado</div>
                <div class="dashboard-value" id="totalLoaned">R$ 0,00</div>
            </div>
            <div class="dashboard-item">
                <div class="dashboard-label">Total Recebido</div>
                <div class="dashboard-value" id="totalReceived">R$ 0,00</div>
            </div>
            <div class="dashboard-item">
                <div class="dashboard-label">Lucro em Juros</div>
                <div class="dashboard-value" id="totalProfit">R$ 0,00</div>
            </div>
            <div class="dashboard-item">
                <div class="dashboard-label">Valor a Receber</div>
                <div class="dashboard-value" id="totalToReceive">R$ 0,00</div>
            </div>
        </div>
        <!-- Fim Dashboard -->

        <button class="primary" onclick="openRegister()">Cadastrar Novo Cliente</button>
        <button class="secondary" onclick="showAllClients()">Mostrar Todos os Clientes</button>

        <div class="search-area">
            <input type="search" id="clientSearch" placeholder="Digite o nome do cliente..." aria-label="Buscar cliente" />
            <button class="secondary" onclick="searchClient()">Buscar Cliente</button>
        </div>

        <div class="client-list">
            <h2>Mensalidades Vencendo nos Pr√≥ximos 5 Dias</h2>
            <ul id="duePayments">
                <!-- Ser√° populada por JS -->
            </ul>
        </div>
    </div>

    <!-- Tela de Registro de Novo Cliente -->
    <div id="registerForm" class="hidden" aria-label="Formul√°rio Cadastro Cliente">
        <h2>Cadastrar Novo Cliente</h2>
        <form id="formRegister" onsubmit="return false;">
            <input type="text" id="name" required placeholder="Nome completo" autocomplete="off" />
            <input type="tel" id="phone" pattern="[0-9\s\-\+\(\)]{8,15}" placeholder="Telefone" autocomplete="off" />
            <input type="text" id="cpf" placeholder="CPF" autocomplete="off" />
            <input type="text" id="rg" placeholder="RG" autocomplete="off" />
            <input type="text" id="address" placeholder="Endere√ßo" autocomplete="off" />
            <input type="text" id="cep" placeholder="CEP" autocomplete="off" />
            <input type="file" id="photo" accept="image/*" onchange="updatePhotoPreview(event)" />
            <img id="photoPreview" alt="Preview da foto do cliente" class="hidden" />
            <button type="button" class="primary" onclick="registerClient()">Salvar Cliente</button>
            <button type="button" class="secondary" onclick="closeRegister()">Cancelar</button>
        </form>
    </div>

    <!-- Tela do Perfil do Cliente -->
    <div id="clientProfile" class="hidden" aria-label="Perfil do Cliente">
        <h2>Perfil do Cliente</h2>
        <div class="profile-flex">
            <img id="clientPhoto" src="" alt="Foto do Cliente" />
            <div id="clientData"></div>
        </div>

        <div id="loanSection" aria-label="Adicionar empr√©stimo">
            <input type="number" id="loanAmount" placeholder="Valor do Empr√©stimo (R$)" min="0" step="0.01" aria-label="Valor do empr√©stimo" />
            <input type="number" id="interestRate" placeholder="Porcentagem de Juros (%)" min="0" max="100" step="0.01" aria-label="Porcentagem de juros" />
            <button onclick="addLoan()" class="primary" aria-label="Adicionar empr√©stimo">Adicionar</button>
        </div>

        <div id="loanInfo"></div>

        <div id="profileActions">
            <button onclick="editProfile()" class="secondary btn-margin">Editar Perfil</button>
            <button onclick="chargeDebt()" class="secondary">Cobrar</button>
            <button onclick="showPayments()" class="secondary btn-margin">Visualizar Pagamentos</button>
            <button onclick="confirmDeleteClient(currentClient.id)" class="secondary btn-margin">Excluir Cliente</button>
        </div>

        <div id="paymentSection" class="hidden section-margin">
            <input type="number" id="payAmount" placeholder="Insira valor pago (R$)" min="0" step="0.01" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius:6px; border: 1px solid #ccc;" />
            <button onclick="confirmPayment()" class="primary btn-fullwidth">Confirmar Pagamento</button>
        </div>

        <div id="reminderMessage" class="hidden"></div>

        <button onclick="backToHome()" class="secondary btn-margin-lg">Voltar</button>
    </div>

</div>

<!-- Modal para visualizar pagamentos -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>Pagamentos</h3>
        <ul id="paymentList"></ul>
    </div>
</div>

<!-- Modal para recibo de cobran√ßa -->
<div id="receiptModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeReceiptModal()">&times;</span>
        <h3>Recibo de Cobran√ßa</h3>
        <pre id="receiptContent"></pre>
        <button id="shareButton" onclick="shareReceipt()" class="primary">Compartilhar via WhatsApp</button>
    </div>
</div>

<!-- Modal para relat√≥rio -->
<div id="reportModal" class="modal">
    <div class="modal-content modal-maxwidth">
        <span class="close" onclick="closeReportModal()">&times;</span>
        <h3>Relat√≥rio Geral</h3>
        <div id="reportFilters" class="mb-10"></div>
        <div id="reportContent" class="report-content-scroll"></div>
        <button class="primary" onclick="exportReport('csv')">Exportar CSV</button>
        <button class="secondary" onclick="exportReport('json')">Exportar JSON</button>
    </div>
</div>

<script>
/* 
SIMULA√á√ÉO DE BANCO DE DADOS
Armazena clientes com dados e mensalidades, tudo em arrays e objetos JS.
*/
let clients = [
    {
        id: 1,
        name: "Ana Silva",
        phone: "(11) 91234-5678",
        cpf: "123.456.789-00",
        rg: "MG-12.345.678",
        address: "Rua das Flores, 123",
        cep: "12345-678",
        photo: "",
        loans: [],
        payments: [] // Adicionando array para pagamentos
    },
    {
        id: 2,
        name: "Carlos Souza",
        phone: "(21) 98765-4321",
        cpf: "987.654.321-00",
        rg: "RJ-87.654.321",
        address: "Av. Brasil, 456",
        cep: "87654-321",
        photo: "",
        loans: [],
        payments: [] // Adicionando array para pagamentos
    }
];
let clientIdCounter = clients.length + 1;
let currentClient = null;
let editingProfile = false;

// Fun√ß√£o para adicionar dias a uma data
function addDays(date, days) {
    let result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
}

// Formata data para dd/mm/yyyy
function formatDate(d) {
    if (!(d instanceof Date)) return "";
    let day = String(d.getDate()).padStart(2, "0");
    let month = String(d.getMonth() + 1).padStart(2, "0");
    let year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

// Formata valor monet√°rio com R$
function formatCurrency(value) {
    return "R$ " + value.toFixed(2).replace(".", ",");
}

// Atualiza lista mensalidades vencendo em at√© 5 dias
function updateDuePaymentsList() {
    const ul = document.getElementById("duePayments");
    ul.innerHTML = "";

    const today = new Date();
    const limitDate = addDays(today, 5);

    let found = false;
    for (const client of clients) {
        // S√≥ mostra clientes que t√™m empr√©stimos ativos (d√≠vida > 0)
        if (!client.loans || client.loans.length === 0) continue;
        const hasActiveLoan = client.loans.some(loan => loan.debt > 0);
        if (!hasActiveLoan) continue;
        for (const loan of client.loans) {
            let due = new Date(loan.dueDate);
            if (due >= today && due <= limitDate && loan.debt > 0) {
                found = true;
                let li = document.createElement("li");
                li.textContent = `${client.name} - ${formatCurrency(loan.debt)} - Vence em ${formatDate(due)}`;
                ul.appendChild(li);
            }
        }
    }
    if (!found) {
        let li = document.createElement("li");
        li.textContent = "Nenhuma mensalidade vencendo nos pr√≥ximos 5 dias.";
        ul.appendChild(li);
    }
}

// Atualiza preview da foto ao selecionar no cadastro
function updatePhotoPreview(event) {
    const preview = document.getElementById("photoPreview");
    const file = event.target.files[0];
    if(file){
        const url = URL.createObjectURL(file);
        preview.src = url;
        preview.classList.remove("hidden");
    } else {
        preview.src = "";
        preview.classList.add("hidden");
    }
}

// Abre tela de cadastro de novo cliente
function openRegister(){
    document.getElementById("homeScreen").classList.add("hidden");
    document.getElementById("registerForm").classList.remove("hidden");
    document.getElementById("clientProfile").classList.add("hidden");
    clearRegisterForm();
    editingProfile = false;
}

// Fecha cadastro, volta pra home
function closeRegister(){
    document.getElementById("homeScreen").classList.remove("hidden");
    document.getElementById("registerForm").classList.add("hidden");
    document.getElementById("clientProfile").classList.add("hidden");
    clearRegisterForm();
    editingProfile = false;
}

// Limpa formul√°rio de cadastro e reseta foto
function clearRegisterForm() {
    document.getElementById("formRegister").reset();
    const preview = document.getElementById("photoPreview");
    preview.src = "";
    preview.classList.add("hidden");
}

// Registra cliente novo ou salva edi√ß√£o
function registerClient(){
    // Objeto cliente
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const cpf = document.getElementById("cpf").value.trim();
    const rg = document.getElementById("rg").value.trim();
    const address = document.getElementById("address").value.trim();
    const cep = document.getElementById("cep").value.trim();
    const photoFile = document.getElementById("photo").files[0];

    if (!name) {
        alert("Por favor, preencha o nome.");
        return;
    }

    let photoURL = "";
    if(photoFile) {
        photoURL = URL.createObjectURL(photoFile);
    }

    if(editingProfile && currentClient){
        // Edita perfil
        currentClient.name = name;
        currentClient.phone = phone;
        currentClient.cpf = cpf;
        currentClient.rg = rg;
        currentClient.address = address;
        currentClient.cep = cep;
        if(photoURL) currentClient.photo = photoURL;
        else if (!currentClient.photo) currentClient.photo = "";
    } else {
        // Cria novo cliente
        const newClient = {
            id: clientIdCounter++,
            name,
            phone,
            cpf,
            rg,
            address,
            cep,
            photo: photoURL,
            loans: [],
            payments: [] // Adicionando array para pagamentos
        };
        clients.push(newClient);
        currentClient = newClient;
    }

    alert(editingProfile ? "Perfil atualizado com sucesso!" : "Cliente cadastrado com sucesso!");

    // Limpa o formul√°rio e preview ap√≥s o cadastro
    clearRegisterForm();
    saveClientsToStorage(); // Salva ap√≥s cadastro

    // Redireciona para o perfil do cliente cadastrado/atualizado
    showProfile(currentClient.id);
}

// Busca cliente pelo nome (case insensitive)
function searchClient(){
    const input = document.getElementById("clientSearch");
    const searchInput = input.value.trim().toLowerCase();
    
    // Verifica se o comprimento do texto √© maior ou igual a 4
    if(searchInput.length < 4){
        // Limpa a lista se menos de 4 caracteres
        document.getElementById("duePayments").innerHTML = "";
        return;
    }

    const clientFound = clients.filter(c => c.name.toLowerCase().includes(searchInput));
    
    // Limpa a lista antes de mostrar os resultados
    const ul = document.getElementById("duePayments");
    ul.innerHTML = "";

    if(clientFound.length > 0){
        clientFound.forEach(client => {
            let li = document.createElement("li");
            li.textContent = client.name; // Exibe o nome do cliente
            li.onclick = () => showProfile(client.id); // Ao clicar, mostra o perfil
            ul.appendChild(li);
        });
    } else {
        let li = document.createElement("li");
        li.textContent = "Nenhum cliente encontrado.";
        ul.appendChild(li);
    }
}

// Adiciona um evento de input para buscar enquanto digita
document.getElementById("clientSearch").addEventListener("input", searchClient);

// Exibe todos os clientes cadastrados
function showAllClients() {
    const ul = document.getElementById("duePayments");
    ul.innerHTML = ""; // Limpa a lista atual

    clients.forEach(client => {
        let li = document.createElement("li");
        li.textContent = client.name; // Exibe o nome do cliente
        li.onclick = () => showProfile(client.id); // Ao clicar, mostra o perfil
        ul.appendChild(li);
    });
}

// Exibe tela do perfil do cliente
function showProfile(clientId){
    const home = document.getElementById("homeScreen");
    const register = document.getElementById("registerForm");
    const profile = document.getElementById("clientProfile");
    const client = clients.find(c => c.id === clientId);
    if(!client){
        alert("Cliente n√£o encontrado.");
        return;
    }
    currentClient = client;
    editingProfile = false;

    home.classList.add("hidden");
    register.classList.add("hidden");
    profile.classList.remove("hidden");

    const photoSrc = client.photo || "https://via.placeholder.com/120?text=Sem+Foto";
    document.getElementById("clientPhoto").src = photoSrc;

    const dataDiv = document.getElementById("clientData");
    dataDiv.innerHTML = `
        <strong>Nome:</strong> ${client.name}<br>
        <strong>Telefone:</strong> ${client.phone}<br>
        <strong>CPF:</strong> ${client.cpf}<br>
        <strong>RG:</strong> ${client.rg}<br>
        <strong>Endere√ßo:</strong> ${client.address}<br>
        <strong>CEP:</strong> ${client.cep}<br>
    `;

    updateLoanInfo(); // Atualiza a exibi√ß√£o dos empr√©stimos
    // Alerta de inadimpl√™ncia
    const reminderDiv = document.getElementById("reminderMessage");
    const hasOverdue = currentClient.loans && currentClient.loans.some(l => l.debt > 0 && new Date(l.dueDate) < new Date());
    if (hasOverdue) {
        reminderDiv.textContent = "‚ö†Ô∏è Este cliente est√° inadimplente! Existem d√≠vidas vencidas.";
        reminderDiv.classList.remove("hidden");
    } else {
        hideReminder();
    }
    hidePaymentSection();
}

// Esconde alerta de inadimpl√™ncia
function hideReminder() {
    const reminderDiv = document.getElementById("reminderMessage");
    reminderDiv.classList.add("hidden");
    reminderDiv.textContent = "";
}

// Atualiza exibi√ß√£o dos empr√©stimos
function updateLoanInfo(){
    const loanInfo = document.getElementById("loanInfo");
    if(!currentClient.loans || currentClient.loans.length === 0){
        loanInfo.innerHTML = "<em>Sem empr√©stimos registrados.</em>";
        return;
    }
    let html = "<h3>Empr√©stimos:</h3>";
    currentClient.loans.forEach((loan, index) => {
        html += `<div class="loan-card">
            <div class="loan-info">
                <strong>Empr√©stimo ${index + 1}</strong><br>
                Valor Inicial: ${formatCurrency(loan.amount)}<br>
                Juros ao M√™s: ${loan.interest.toFixed(2)}%<br>
                D√≠vida Atual: ${formatCurrency(loan.debt)}<br>
                Vencimento: ${formatDate(new Date(loan.dueDate))}
            </div>`;
        if (loan.debt > 0) {
            html += `<button class='pay-fab' title='Pagar este empr√©stimo' onclick='payDebtForLoan(${index})'><span>üí∏</span></button>`;
        }
        html += `</div>`;
    });
    loanInfo.innerHTML = html;
    // Exibe selo de bom pagador se n√£o houver d√≠vidas
    const hasDebt = currentClient.loans.some(loan => loan.debt > 0);
    const nameTitle = document.querySelector('#clientProfile h2');
    if (!hasDebt) {
        if (!document.getElementById('goodPayerBadge')) {
            const badge = document.createElement('span');
            badge.id = 'goodPayerBadge';
            badge.textContent = '  ‚≠ê Bom Pagador';
            badge.style.color = '#28a745';
            badge.style.fontSize = '1em';
            badge.style.marginLeft = '8px';
            nameTitle.appendChild(badge);
        }
    } else {
        const badge = document.getElementById('goodPayerBadge');
        if (badge) badge.remove();
    }
}

// Mostrar √°rea para pagamento
function payDebt(){
    if(!currentClient) return alert("Nenhum cliente selecionado.");
    if(!currentClient.loans || currentClient.loans.length === 0){
        alert("Cliente n√£o possui d√≠vidas.");
        return;
    }
    document.getElementById("paymentSection").classList.remove("hidden");
    hideReminder();
}

// Nova fun√ß√£o para pagar um empr√©stimo espec√≠fico
function payDebtForLoan(loanIndex) {
    if(!currentClient) return alert("Nenhum cliente selecionado.");
    const loan = currentClient.loans[loanIndex];
    if(!loan || loan.debt <= 0) {
        alert("Este empr√©stimo n√£o possui d√≠vida a pagar.");
        return;
    }
    // Exibe a √°rea de pagamento e associa ao empr√©stimo correto
    document.getElementById("paymentSection").classList.remove("hidden");
    hideReminder();
    // Salva o √≠ndice do empr√©stimo a ser pago
    window.loanToPayIndex = loanIndex;
}

// Confirmar pagamento
function confirmPayment(){
    const payInput = document.getElementById("payAmount");
    let paidValue = parseFloat(payInput.value);
    if(isNaN(paidValue) || paidValue <= 0){
        alert("Insira um valor v√°lido para pagamento.");
        payInput.focus();
        return;
    }
    // Paga o empr√©stimo selecionado
    let loanIndex = typeof window.loanToPayIndex === 'number' ? window.loanToPayIndex : null;
    let loan = null;
    if (loanIndex !== null && currentClient.loans[loanIndex]) {
        loan = currentClient.loans[loanIndex];
    } else {
        // fallback: paga o primeiro empr√©stimo com d√≠vida
        loan = currentClient.loans.find(ln => ln.debt > 0);
    }
    if(!loan){
        alert("N√£o h√° d√≠vidas a pagar.");
        hidePaymentSection();
        payInput.value = "";
        return;
    }
    const currentDebt = loan.debt;
    currentClient.payments.push({ amount: paidValue, date: new Date() });
    if(paidValue >= currentDebt){
        loan.debt = 0;
        loan.amount = 0;
        loan.dueDate = addDays(new Date(), 30);
        alert("D√≠vida quitada com sucesso!");
    } else {
        loan.debt -= paidValue;
        loan.dueDate = addDays(new Date(), 30);
        alert("Pagamento parcial realizado. D√≠vida recalculada para o pr√≥ximo m√™s.");
    }
    payInput.value = "";
    hidePaymentSection();
    updateLoanInfo();
    updateDuePaymentsList();
    saveClientsToStorage();
    // Limpa o √≠ndice ap√≥s o pagamento
    window.loanToPayIndex = null;
}

// Esconder se√ß√£o pagamento
function hidePaymentSection(){
    document.getElementById("paymentSection").classList.add("hidden");
    document.getElementById("payAmount").value = "";
}

// Cobrar - exibe recibo de cobran√ßa
function chargeDebt(){
    if(!currentClient) return alert("Nenhum cliente selecionado.");
    if(!currentClient.loans || currentClient.loans.length === 0){
        alert("Cliente n√£o possui d√≠vidas.");
        return;
    }
    let totalDebt = 0;
    for(let loan of currentClient.loans){
        totalDebt += loan.debt;
    }
    
    const receiptMessage = `Ol√°, ${currentClient.name}!\n\n` +
        `Estamos entrando em contato para lembrar que hoje vence o pagamento do seu empr√©stimo pessoal no valor de ${formatCurrency(totalDebt)}.\n\n` +
        `Se precisar de mais informa√ß√µes ou assist√™ncia, estamos √† disposi√ß√£o.\n\n` +
        `Agradecemos pela sua aten√ß√£o e aguardamos o pagamento.\n\n` +
        `Atenciosamente,\n\n` +
        `[Seu Nome ou Nome da Empresa]`;

    // Exibir recibo em um modal
    document.getElementById("receiptContent").textContent = receiptMessage;
    document.getElementById("receiptModal").style.display = "block"; // Exibe o modal do recibo
}

// Fun√ß√£o para compartilhar recibo via WhatsApp
function shareReceipt() {
    const totalDebt = currentClient.loans.reduce((sum, loan) => sum + loan.debt, 0);
    const message = `Ol√°, ${currentClient.name}!\n\n` +
        `Estamos entrando em contato para lembrar que hoje vence o pagamento do seu empr√©stimo pessoal no valor de ${formatCurrency(totalDebt)}.\n\n` +
        `Se precisar de mais informa√ß√µes ou assist√™ncia, estamos √† disposi√ß√£o.\n\n` +
        `Agradecemos pela sua aten√ß√£o e aguardamos o pagamento.\n\n` +
        `Atenciosamente,\n\n` +
        `[Seu Nome ou Nome da Empresa]`;
    
    const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

// Fechar modal do recibo
function closeReceiptModal() {
    document.getElementById("receiptModal").style.display = "none"; // Esconde o modal do recibo
}

// Cria o modal de relat√≥rio
const reportModal = document.createElement("div");
reportModal.id = "reportModal";
reportModal.className = "modal";
reportModal.innerHTML = `
    <div class="modal-content modal-maxwidth">
        <span class="close" onclick="closeReportModal()">&times;</span>
        <h3>Relat√≥rio Geral</h3>
        <div id="reportFilters" class="mb-10"></div>
        <div id="reportContent" class="report-content-scroll"></div>
        <button class="primary" onclick="exportReport('csv')">Exportar CSV</button>
        <button class="secondary" onclick="exportReport('json')">Exportar JSON</button>
    </div>
`;
document.body.appendChild(reportModal);

// Fun√ß√£o para abrir o modal de relat√≥rio
function openReportModal() {
    updateAllLoansInterest(); // Atualiza juros antes de mostrar
    renderReport();
    document.getElementById("reportModal").style.display = "block";
}
function closeReportModal() {
    document.getElementById("reportModal").style.display = "none";
}

// Atualiza juros de todos os empr√©stimos vencidos
function updateAllLoansInterest() {
    const today = new Date();
    clients.forEach(client => {
        if (client.loans) {
            client.loans.forEach(loan => {
                if (loan.debt > 0 && new Date(loan.dueDate) < today) {
                    // Aplica juros simples por m√™s vencido
                    const monthsLate = Math.floor((today - new Date(loan.dueDate)) / (1000*60*60*24*30));
                    if (monthsLate > 0) {
                        // Juros simples: d√≠vida = valor original + (valor original * juros * meses)
                        loan.debt = loan.amount + (loan.amount * (loan.interest/100) * monthsLate);
                        // Atualiza data de vencimento para o pr√≥ximo m√™s
                        loan.dueDate = addDays(new Date(loan.dueDate), 30*monthsLate);
                    }
                }
            });
        }
    });
    saveClientsToStorage();
}

// Renderiza o relat√≥rio geral
function renderReport() {
    const content = document.getElementById("reportContent");
    let html = "<table style='width:100%;border-collapse:collapse;font-size:0.95em;'>";
    html += "<tr style='background:#e6f2ff;'><th>Cliente</th><th>Telefone</th><th>D√≠vida Total</th><th>Empr√©stimos</th><th>Pagamentos</th><th>Status</th></tr>";
    clients.forEach(client => {
        const totalDebt = client.loans ? client.loans.reduce((sum, l) => sum + l.debt, 0) : 0;
        const totalPaid = client.payments ? client.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
        const hasOverdue = client.loans && client.loans.some(l => l.debt > 0 && new Date(l.dueDate) < new Date());
        html += `<tr style='background:${hasOverdue ? "#fff3cd" : "#f9f9f9"};'>` +
            `<td>${client.name}</td>` +
            `<td>${client.phone}</td>` +
            `<td>${formatCurrency(totalDebt)}</td>` +
            `<td>${client.loans && client.loans.length ? client.loans.length : 0}</td>` +
            `<td>${formatCurrency(totalPaid)}</td>` +
            `<td>${hasOverdue ? '<span style="color:#d9534f;font-weight:bold;">Inadimplente</span>' : '<span style="color:#28a745;">OK</span>'}</td>` +
            `</tr>`;
    });
    html += "</table>";
    content.innerHTML = html;
}

// Exporta relat√≥rio em CSV ou JSON
function exportReport(type) {
    let rows = [
        ["Cliente", "Telefone", "D√≠vida Total", "Empr√©stimos", "Pagamentos", "Status"]
    ];
    clients.forEach(client => {
        const totalDebt = client.loans ? client.loans.reduce((sum, l) => sum + l.debt, 0) : 0;
        const totalPaid = client.payments ? client.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
        const hasOverdue = client.loans && client.loans.some(l => l.debt > 0 && new Date(l.dueDate) < new Date());
        rows.push([
            client.name,
            client.phone,
            totalDebt.toFixed(2).replace('.', ','),
            client.loans && client.loans.length ? client.loans.length : 0,
            totalPaid.toFixed(2).replace('.', ','),
            hasOverdue ? "Inadimplente" : "OK"
        ]);
    });
    if (type === 'csv') {
        let csv = rows.map(r => r.map(v => '"'+v+'"').join(';')).join('\n');
        downloadFile(csv, 'relatorio_agi.csv', 'text/csv');
    } else if (type === 'json') {
        downloadFile(JSON.stringify(clients, null, 2), 'relatorio_agi.json', 'application/json');
    }
}
function downloadFile(content, filename, mime) {
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
}

// Salva clients no localStorage
function saveClientsToStorage() {
    localStorage.setItem('agi_clients', JSON.stringify(clients));
    updateDashboard();
}
// Carrega clients do localStorage
function loadClientsFromStorage() {
    const data = localStorage.getItem('agi_clients');
    if (data) {
        clients = JSON.parse(data);
        clients.forEach(client => {
            if (client.loans) {
                client.loans.forEach(loan => {
                    loan.dueDate = new Date(loan.dueDate);
                });
            }
        });
        clientIdCounter = clients.length + 1;
    }
    updateAllLoansInterest();
    updateDashboard();
}

// Fun√ß√£o para calcular e atualizar o dashboard financeiro
function updateDashboard() {
    let totalLoaned = 0;
    let totalReceived = 0;
    let totalToReceive = 0;
    let totalProfit = 0;
    clients.forEach(client => {
        if (client.loans && client.loans.length) {
            client.loans.forEach(loan => {
                totalLoaned += loan.amount || 0;
                totalToReceive += loan.debt || 0;
                // Lucro em juros: diferen√ßa entre d√≠vida atual e valor inicial, se d√≠vida > 0
                if (loan.debt > 0) {
                    totalProfit += (loan.debt - loan.amount);
                }
            });
        }
        if (client.payments && client.payments.length) {
            client.payments.forEach(p => {
                totalReceived += p.amount || 0;
            });
        }
    });
    document.getElementById('totalLoaned').textContent = formatCurrency(totalLoaned);
    document.getElementById('totalReceived').textContent = formatCurrency(totalReceived);
    document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
    document.getElementById('totalToReceive').textContent = formatCurrency(totalToReceive);
}

// Atualiza dashboard ao iniciar
updateDashboard();

// Chama ao iniciar
loadClientsFromStorage();
updateDuePaymentsList();

// Exibe o modal de pagamentos do cliente atual
function showPayments() {
    if (!currentClient) {
        alert("Nenhum cliente selecionado.");
        return;
    }
    const paymentList = document.getElementById("paymentList");
    paymentList.innerHTML = "";
    if (!currentClient.payments || currentClient.payments.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Nenhum pagamento registrado.";
        paymentList.appendChild(li);
    } else {
        currentClient.payments.forEach((p, idx) => {
            const li = document.createElement("li");
            const date = new Date(p.date);
            li.textContent = `Pagamento ${idx + 1}: ${formatCurrency(p.amount)} em ${formatDate(date)}`;
            paymentList.appendChild(li);
        });
    }
    document.getElementById("paymentModal").style.display = "block";
}

// Fecha o modal de pagamentos
function closeModal() {
    document.getElementById("paymentModal").style.display = "none";
}

// Adiciona um novo empr√©stimo ao cliente atual
function addLoan() {
    if (!currentClient) {
        alert("Nenhum cliente selecionado.");
        return;
    }
    const amountInput = document.getElementById("loanAmount");
    const interestInput = document.getElementById("interestRate");
    const amount = parseFloat(amountInput.value);
    const interest = parseFloat(interestInput.value);
    if (isNaN(amount) || amount <= 0) {
        alert("Informe um valor de empr√©stimo v√°lido.");
        amountInput.focus();
        return;
    }
    if (isNaN(interest) || interest < 0) {
        alert("Informe uma taxa de juros v√°lida.");
        interestInput.focus();
        return;
    }
    // Vencimento padr√£o: 30 dias a partir de hoje
    const dueDate = addDays(new Date(), 30);
    const newLoan = {
        amount: amount,
        interest: interest,
        debt: amount,
        dueDate: dueDate
    };
    if (!currentClient.loans) currentClient.loans = [];
    currentClient.loans.push(newLoan);
    amountInput.value = "";
    interestInput.value = "";
    updateLoanInfo();
    updateDuePaymentsList();
    saveClientsToStorage();
    alert("Empr√©stimo adicionado com sucesso!");
}

// Fun√ß√£o para editar o perfil do cliente atual
function editProfile() {
    if (!currentClient) {
        alert("Nenhum cliente selecionado.");
        return;
    }
    // Preenche o formul√°rio de cadastro com os dados do cliente atual
    document.getElementById("name").value = currentClient.name || "";
    document.getElementById("phone").value = currentClient.phone || "";
    document.getElementById("cpf").value = currentClient.cpf || "";
    document.getElementById("rg").value = currentClient.rg || "";
    document.getElementById("address").value = currentClient.address || "";
    document.getElementById("cep").value = currentClient.cep || "";
    // Foto n√£o √© preenchida por seguran√ßa do navegador
    // Mostra preview da foto se existir
    const preview = document.getElementById("photoPreview");
    if (currentClient.photo) {
        preview.src = currentClient.photo;
        preview.classList.remove("hidden");
    } else {
        preview.src = "";
        preview.classList.add("hidden");
    }
    // Alterna telas
    document.getElementById("homeScreen").classList.add("hidden");
    document.getElementById("registerForm").classList.remove("hidden");
    document.getElementById("clientProfile").classList.add("hidden");
    editingProfile = true;
}

// Fun√ß√£o para voltar para a tela inicial (home)
function backToHome() {
    document.getElementById("homeScreen").classList.remove("hidden");
    document.getElementById("registerForm").classList.add("hidden");
    document.getElementById("clientProfile").classList.add("hidden");
    updateDuePaymentsList();
}
</script>

<!-- Firebase App (modular SDK) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {'apiKey': 'AIzaSyBBAbq0_GYTPQkKlOEX3MJp9Vzj3ZzyJ6I', 'authDomain': 'app-facil-87595.firebaseapp.com', 'projectId': 'app-facil-87595', 'storageBucket': 'app-facil-87595.firebasestorage.app', 'messagingSenderId': '775213961118', 'appId': '1:775213961118:web:9ee69152052367b5e1d08f', 'measurementId': 'G-WXKQRJY766'};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.checkToken = async function() {
    const token = document.getElementById("tokenInput").value.trim();
    if (!token) {
        alert("Digite um token.");
        return;
    }
    const docRef = doc(db, "tokens", token);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("homeScreen").style.display = "block";
    } else {
        alert("Token inv√°lido.");
    }
  };
</script>

</body>
</html>